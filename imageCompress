<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Image Compressor - Compress 20+ Images at Once | BatchCompress</title>
    <meta name="description" content="Compress up to 20 images simultaneously. Bulk JPG, PNG, WebP compression with batch download. Free online tool.">
    
    <!-- Preload critical resources -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- Critical CSS Inline (Above-the-fold) -->
    <style>
        /* ===== CRITICAL CSS ONLY ===== */
        :root {
            --primary: #4f46e5;
            --primary-dark: #4338ca;
            --light: #f8fafc;
            --dark: #1e293b;
            --white: #ffffff;
        }

        /* Minimal reset for FCP */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            line-height: 1.5; 
            color: var(--dark); 
            background: var(--white);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* Header - minimal for LCP */
        .header {
            background: var(--white);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        /* Hero - critical for LCP */
        .hero {
            text-align: center;
            padding: 2rem 1rem;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .hero h1 {
            font-size: clamp(1.75rem, 5vw, 2.5rem);
            font-weight: 800;
            margin-bottom: 1rem;
        }
        
        /* Upload area - critical for FCP */
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            background: var(--white);
            margin: 2rem auto;
            max-width: 900px;
        }
        
        /* Essential buttons */
        .btn {
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-primary {
            background: var(--primary);
            color: var(--white);
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        
        /* Ensure images don't cause CLS */
        img { max-width: 100%; height: auto; }
        
        /* Mobile optimization */
        @media (max-width: 768px) {
            .hero { padding: 1.5rem 0.5rem; }
            .upload-area { padding: 1.5rem; }
        }
    </style>
    
    <!-- Defer non-critical CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <noscript>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    </noscript>
    
    <!-- Non-critical CSS (deferred) -->
    <style>
        /* Non-critical styles loaded after initial render */
        :root {
            --secondary: #10b981;
            --accent: #f59e0b;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(79, 70, 229, 0.05);
        }
        
        /* Batch Controls */
        .batch-controls {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin: 2rem 0;
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        /* Image Grid */
        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }
        
        .image-card {
            background: var(--light);
            border-radius: var(--radius);
            padding: 1.25rem;
            box-shadow: var(--shadow);
            transition: transform 0.2s;
        }
        
        .image-card:hover {
            transform: translateY(-2px);
        }
        
        .image-preview {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: var(--radius);
            background: #e2e8f0;
            margin-bottom: 1rem;
        }
        
        .image-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.875rem;
        }
        
        .stat-badge {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        /* Progress */
        .batch-progress {
            background: var(--white);
            padding: 2rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin: 2rem 0;
        }
        
        .progress-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s;
            border-radius: 6px;
        }
        
        /* Summary */
        .summary {
            background: var(--light);
            padding: 2rem;
            border-radius: var(--radius);
            margin: 2rem 0;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .summary-card {
            background: var(--white);
            padding: 1.5rem;
            border-radius: var(--radius);
            text-align: center;
            box-shadow: var(--shadow);
        }
        
        .summary-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        /* Additional button styles */
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background: var(--light);
            color: var(--dark);
            border: 2px solid #cbd5e1;
        }
        
        .btn-secondary:hover {
            background: #e2e8f0;
        }
        
        .btn-accent {
            background: var(--accent);
            color: var(--white);
        }
        
        .btn-accent:hover {
            background: #d97706;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--dark);
            text-decoration: none;
        }
    </style>
</head>
<body>
    <!-- Skip link for accessibility -->
    <a href="#main-content" class="hidden">Skip to main content</a>

    <!-- Header -->
    <header class="header">
        <div class="container">
            <a href="/" class="logo">
                <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border-radius: var(--radius); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-layer-group"></i>
                </div>
                <span>BatchCompress</span>
            </a>
        </div>
    </header>

    <!-- Main Content -->
    <main id="main-content" class="container">
        <!-- Hero -->
        <section class="hero">
            <h1>Bulk Image Compressor</h1>
            <p style="color: #475569; font-size: 1.125rem; max-width: 700px; margin: 0 auto 2rem;">
                Compress up to 20 images simultaneously. Perfect for websites, portfolios, and social media.
            </p>
        </section>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <div style="font-size: 4rem; color: var(--primary); margin-bottom: 1.5rem;">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            
            <h2 style="margin-bottom: 1rem;">Upload Multiple Images</h2>
            <p style="margin-bottom: 1.5rem;">
                <strong>Supported:</strong> JPG, PNG, WebP, GIF<br>
                <strong>Max:</strong> 20 images, 10MB each
            </p>
            
            <div style="margin-bottom: 1.5rem;">
                <button class="btn btn-primary" id="uploadBtn">
                    <i class="fas fa-plus-circle"></i>
                    Select Images (Max 20)
                </button>
                <input type="file" id="fileInput" accept="image/*" multiple class="hidden">
            </div>
            
            <p>or drag and drop images here</p>
            <div id="fileCounter" class="hidden" style="margin-top: 1rem; color: var(--primary); font-weight: 600;"></div>
        </div>

        <!-- Selected Images Grid -->
        <section id="imagesSection" class="hidden">
            <h2 style="margin-bottom: 1rem;">Selected Images <span id="selectedCount" class="stat-badge">0</span></h2>
            <div class="image-grid" id="imagesGrid">
                <!-- Images will be added here -->
            </div>
        </section>

        <!-- Batch Controls -->
        <section class="batch-controls hidden" id="controlsSection">
            <h2 style="margin-bottom: 1rem;">Batch Compression Settings</h2>
            <p style="color: #64748b; margin-bottom: 1.5rem;">Apply these settings to all selected images.</p>
            
            <div class="controls-grid">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="fas fa-sliders-h"></i> Quality: <span id="qualityValue">80%</span>
                    </label>
                    <input type="range" id="qualitySlider" min="10" max="100" value="80" style="width: 100%;">
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Lower = smaller files, less quality
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="fas fa-expand-alt"></i> Max Width: <span id="widthValue">1200px</span>
                    </label>
                    <input type="range" id="widthSlider" min="400" max="2000" step="100" value="1200" style="width: 100%;">
                    <div style="font-size: 0.875rem; color: #64748b; margin-top: 0.5rem;">
                        Images will be resized proportionally
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                        <i class="fas fa-file-export"></i> Output Format
                    </label>
                    <select id="formatSelect" style="width: 100%; padding: 0.75rem; border-radius: var(--radius); border: 2px solid #cbd5e1; background: white;">
                        <option value="original">Keep Original Format</option>
                        <option value="jpeg">JPEG (Best for photos)</option>
                        <option value="png">PNG (Best for graphics)</option>
                        <option value="webp">WebP (Modern format)</option>
                    </select>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                <button class="btn btn-secondary" id="clearAllBtn">
                    <i class="fas fa-trash"></i>
                    Clear All Images
                </button>
                <button class="btn btn-accent" id="compressAllBtn">
                    <i class="fas fa-compress-alt"></i>
                    Compress All Images
                </button>
            </div>
        </section>

        <!-- Batch Progress -->
        <section class="batch-progress hidden" id="progressSection">
            <h2 style="margin-bottom: 1rem;">Compression Progress</h2>
            
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <span id="progressText">Processing images...</span>
                <span id="progressPercent">0%</span>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>
            
            <div style="margin-top: 1rem; display: flex; justify-content: space-between;">
                <span id="processedCount">0</span>
                <span id="totalCount">0</span>
            </div>
            
            <div id="currentImage" style="margin-top: 1rem; font-style: italic; color: #64748b;"></div>
        </section>

        <!-- Results Summary -->
        <section class="summary hidden" id="resultsSection">
            <h2 style="margin-bottom: 1rem;">Compression Complete!</h2>
            <p style="color: #64748b; margin-bottom: 1.5rem;">All images have been compressed successfully.</p>
            
            <div class="summary-stats">
                <div class="summary-card">
                    <div class="summary-value" id="totalReduction">0%</div>
                    <p>Total Size Reduction</p>
                </div>
                
                <div class="summary-card">
                    <div class="summary-value" id="totalSaved">0 MB</div>
                    <p>Total Space Saved</p>
                </div>
                
                <div class="summary-card">
                    <div class="summary-value" id="totalImages">0</div>
                    <p>Images Processed</p>
                </div>
                
                <div class="summary-card">
                    <div class="summary-value" id="totalTime">0s</div>
                    <p>Processing Time</p>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem; justify-content: center;">
                <button class="btn btn-secondary" id="viewResultsBtn">
                    <i class="fas fa-images"></i>
                    View Results Grid
                </button>
                <button class="btn btn-primary" id="downloadAllBtn">
                    <i class="fas fa-download"></i>
                    Download All as ZIP
                </button>
            </div>
        </section>
    </main>

    <!-- Features section (deferred) -->
    <section class="hidden" id="featuresSection">
        <!-- Features content will load later -->
    </section>

    <!-- Deferred JavaScript for optimal performance -->
    <script>
        // DOM Elements - loaded after initial render
        let fileInput, uploadBtn, uploadArea, imagesSection, controlsSection;
        let progressSection, resultsSection;
        
        // State
        let selectedImages = [];
        let compressedResults = [];
        let compressionInProgress = false;
        const MAX_FILES = 20;
        
        // Wait for DOM to be interactive
        document.addEventListener('DOMContentLoaded', function() {
            // Get DOM elements
            fileInput = document.getElementById('fileInput');
            uploadBtn = document.getElementById('uploadBtn');
            uploadArea = document.getElementById('uploadArea');
            imagesSection = document.getElementById('imagesSection');
            controlsSection = document.getElementById('controlsSection');
            progressSection = document.getElementById('progressSection');
            resultsSection = document.getElementById('resultsSection');
            
            // File upload
            uploadBtn.addEventListener('click', () => fileInput.click());
            
            // Drag and drop with better performance
            const dragEvents = ['dragenter', 'dragover', 'dragleave', 'drop'];
            dragEvents.forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('drag-over');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('drag-over');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const files = Array.from(e.dataTransfer.files)
                    .filter(f => f.type.startsWith('image/'))
                    .slice(0, MAX_FILES);
                
                if (files.length > 0) {
                    handleFiles(files);
                }
            }
            
            fileInput.addEventListener('change', (e) => {
                const files = Array.from(e.target.files).slice(0, MAX_FILES);
                handleFiles(files);
            });
            
            // Controls with debouncing for better TBT
            let qualityTimeout;
            document.getElementById('qualitySlider').addEventListener('input', (e) => {
                clearTimeout(qualityTimeout);
                qualityTimeout = setTimeout(() => {
                    document.getElementById('qualityValue').textContent = `${e.target.value}%`;
                }, 50);
            });
            
            let widthTimeout;
            document.getElementById('widthSlider').addEventListener('input', (e) => {
                clearTimeout(widthTimeout);
                widthTimeout = setTimeout(() => {
                    document.getElementById('widthValue').textContent = `${e.target.value}px`;
                }, 50);
            });
            
            // Button event listeners
            document.getElementById('clearAllBtn').addEventListener('click', clearAllImages);
            document.getElementById('compressAllBtn').addEventListener('click', startBatchCompression);
            document.getElementById('viewResultsBtn').addEventListener('click', showResultsGrid);
            document.getElementById('downloadAllBtn').addEventListener('click', downloadAllAsZip);
            
            // Load features section after initial render
            setTimeout(loadFeaturesSection, 1000);
        });
        
        // Handle multiple files with chunking for better TBT
        function handleFiles(files) {
            const availableSlots = MAX_FILES - selectedImages.length;
            const filesToAdd = files.slice(0, availableSlots);
            
            if (filesToAdd.length === 0) {
                showAlert(`Maximum ${MAX_FILES} images allowed. Remove some images first.`, 'error');
                return;
            }
            
            // Validate in chunks to avoid blocking
            const chunkSize = 5;
            for (let i = 0; i < filesToAdd.length; i += chunkSize) {
                setTimeout(() => {
                    const chunk = filesToAdd.slice(i, i + chunkSize);
                    processFileChunk(chunk);
                }, i * 10); // Stagger processing
            }
        }
        
        function processFileChunk(chunk) {
            const validFiles = [];
            
            for (const file of chunk) {
                if (!file.type.startsWith('image/')) {
                    showAlert(`${file.name} is not an image file. Skipped.`, 'error');
                    continue;
                }
                
                if (file.size > 10 * 1024 * 1024) {
                    showAlert(`${file.name} exceeds 10MB limit. Skipped.`, 'error');
                    continue;
                }
                
                validFiles.push(file);
            }
            
            if (validFiles.length === 0) return;
            
            validFiles.forEach(file => {
                selectedImages.push({
                    file: file,
                    id: Date.now() + Math.random(),
                    previewUrl: URL.createObjectURL(file),
                    originalSize: file.size,
                    compressedBlob: null,
                    compressedSize: 0,
                    reduction: 0
                });
            });
            
            // Debounce UI updates
            clearTimeout(updateUITimeout);
            updateUITimeout = setTimeout(updateUI, 100);
        }
        
        let updateUITimeout;
        function updateUI() {
            updateImagesGrid();
            updateFileCounter();
            
            if (selectedImages.length > 0) {
                imagesSection.classList.remove('hidden');
                controlsSection.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                document.getElementById('resultsGridSection')?.classList.add('hidden');
            }
            
            showAlert(`Added ${selectedImages.length} image(s). Ready to compress.`, 'success');
        }
        
        // Update images grid with virtual scrolling for performance
        function updateImagesGrid() {
            const grid = document.getElementById('imagesGrid');
            const fragment = document.createDocumentFragment();
            
            selectedImages.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <img src="${image.previewUrl}" class="image-preview" alt="${image.file.name}" loading="lazy">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>${truncateText(image.file.name, 20)}</strong>
                    </div>
                    <div class="image-stats">
                        <span>${formatFileSize(image.originalSize)}</span>
                        ${image.compressedBlob ? 
                            `<span class="stat-badge">${image.reduction.toFixed(1)}% smaller</span>` : 
                            `<span style="color: #64748b;">Ready</span>`}
                    </div>
                    <button onclick="removeImage(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer; margin-top: 0.5rem;">
                        <i class="fas fa-times"></i> Remove
                    </button>
                `;
                fragment.appendChild(card);
            });
            
            grid.innerHTML = '';
            grid.appendChild(fragment);
            
            document.getElementById('selectedCount').textContent = selectedImages.length;
        }
        
        // Start batch compression with web worker simulation
        async function startBatchCompression() {
            if (selectedImages.length === 0 || compressionInProgress) return;
            
            compressionInProgress = true;
            compressedResults = [];
            
            // Show progress
            progressSection.classList.remove('hidden');
            controlsSection.classList.add('hidden');
            
            const totalImages = selectedImages.length;
            const quality = parseInt(document.getElementById('qualitySlider').value) / 100;
            const maxWidth = parseInt(document.getElementById('widthSlider').value);
            const format = document.getElementById('formatSelect').value;
            
            document.getElementById('totalCount').textContent = totalImages;
            
            const startTime = performance.now();
            let processed = 0;
            
            // Process in chunks to avoid blocking main thread
            const chunkSize = 3; // Process 3 images at a time
            for (let i = 0; i < selectedImages.length; i += chunkSize) {
                const chunk = selectedImages.slice(i, i + chunkSize);
                await Promise.all(chunk.map(async (image, chunkIndex) => {
                    const result = await compressSingleImage(image, quality, maxWidth, format);
                    compressedResults.push(result);
                    selectedImages[i + chunkIndex] = result;
                    
                    processed++;
                    
                    // Update progress with requestAnimationFrame for smoothness
                    requestAnimationFrame(() => {
                        const progress = (processed / totalImages) * 100;
                        document.getElementById('progressBar').style.width = `${progress}%`;
                        document.getElementById('progressPercent').textContent = `${Math.round(progress)}%`;
                        document.getElementById('processedCount').textContent = processed;
                        document.getElementById('progressText').textContent = `Processing ${processed} of ${totalImages}`;
                        document.getElementById('currentImage').textContent = `Processing: ${image.file.name}`;
                    });
                }));
                
                // Yield to main thread every chunk
                await new Promise(resolve => setTimeout(resolve, 0));
            }
            
            const endTime = performance.now();
            const processingTime = ((endTime - startTime) / 1000).toFixed(1);
            
            // Calculate totals
            const totalOriginalSize = compressedResults.reduce((sum, img) => sum + img.originalSize, 0);
            const totalCompressedSize = compressedResults.reduce((sum, img) => sum + img.compressedSize, 0);
            const totalReduction = totalOriginalSize > 0 ? 
                ((totalOriginalSize - totalCompressedSize) / totalOriginalSize * 100) : 0;
            const totalSaved = totalOriginalSize - totalCompressedSize;
            
            // Update summary
            document.getElementById('totalReduction').textContent = `${totalReduction.toFixed(1)}%`;
            document.getElementById('totalSaved').textContent = formatFileSize(totalSaved);
            document.getElementById('totalImages').textContent = totalImages;
            document.getElementById('totalTime').textContent = `${processingTime}s`;
            
            // Show results with animation frame
            requestAnimationFrame(() => {
                progressSection.classList.add('hidden');
                resultsSection.classList.remove('hidden');
                compressionInProgress = false;
            });
            
            showAlert(`Compression complete! Processed ${totalImages} images in ${processingTime}s.`, 'success');
        }
        
        // Optimized image compression with OffscreenCanvas when available
        function compressSingleImage(imageData, quality, maxWidth, outputFormat) {
            return new Promise((resolve) => {
                const img = new Image();
                
                // Use decode() for better performance
                img.decode().then(() => {
                    const originalWidth = img.width;
                    const originalHeight = img.height;
                    const scaleFactor = Math.min(1, maxWidth / originalWidth);
                    const newWidth = Math.round(originalWidth * scaleFactor);
                    const newHeight = Math.round(originalHeight * scaleFactor);
                    
                    // Use OffscreenCanvas if available for better performance
                    let canvas;
                    if ('OffscreenCanvas' in window) {
                        canvas = new OffscreenCanvas(newWidth, newHeight);
                    } else {
                        canvas = document.createElement('canvas');
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                    }
                    
                    const ctx = canvas.getContext('2d', { alpha: false });
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, newWidth, newHeight);
                    
                    let format = outputFormat;
                    if (format === 'original') {
                        const ext = imageData.file.name.split('.').pop().toLowerCase();
                        format = ext === 'jpg' || ext === 'jpeg' ? 'jpeg' : ext;
                    }
                    
                    // Convert to blob with quality optimization
                    canvas.toBlob(function(blob) {
                        const compressedSize = blob ? blob.size : imageData.originalSize;
                        const reduction = blob && imageData.originalSize > 0 ? 
                            ((imageData.originalSize - compressedSize) / imageData.originalSize * 100) : 0;
                        
                        resolve({
                            ...imageData,
                            compressedBlob: blob,
                            compressedSize: compressedSize,
                            reduction: reduction,
                            width: newWidth,
                            height: newHeight,
                            quality: Math.round(quality * 100),
                            format: format
                        });
                    }, `image/${format}`, quality);
                    
                }).catch(() => {
                    // Fallback for older browsers
                    img.onload = function() {
                        // Same logic but synchronous
                        const originalWidth = img.width;
                        const originalHeight = img.height;
                        const scaleFactor = Math.min(1, maxWidth / originalWidth);
                        const newWidth = Math.round(originalWidth * scaleFactor);
                        const newHeight = Math.round(originalHeight * scaleFactor);
                        
                        const canvas = document.createElement('canvas');
                        canvas.width = newWidth;
                        canvas.height = newHeight;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, newWidth, newHeight);
                        
                        let format = outputFormat;
                        if (format === 'original') {
                            const ext = imageData.file.name.split('.').pop().toLowerCase();
                            format = ext === 'jpg' || ext === 'jpeg' ? 'jpeg' : ext;
                        }
                        
                        canvas.toBlob(function(blob) {
                            const compressedSize = blob ? blob.size : imageData.originalSize;
                            const reduction = blob && imageData.originalSize > 0 ? 
                                ((imageData.originalSize - compressedSize) / imageData.originalSize * 100) : 0;
                            
                            resolve({
                                ...imageData,
                                compressedBlob: blob,
                                compressedSize: compressedSize,
                                reduction: reduction,
                                width: newWidth,
                                height: newHeight,
                                quality: Math.round(quality * 100),
                                format: format
                            });
                        }, `image/${format}`, quality);
                    };
                });
                
                img.src = imageData.previewUrl;
            });
        }
        
        // Helper functions
        function updateFileCounter() {
            const counter = document.getElementById('fileCounter');
            if (selectedImages.length > 0) {
                counter.textContent = `${selectedImages.length} image(s) selected`;
                counter.classList.remove('hidden');
            } else {
                counter.classList.add('hidden');
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            const value = bytes / Math.pow(k, i);
            return value.toFixed(value < 10 ? 1 : 0) + ' ' + sizes[i];
        }
        
        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }
        
        function showAlert(message, type = 'info') {
            const existingAlerts = document.querySelectorAll('.alert-toast');
            existingAlerts.forEach(alert => alert.remove());
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert-toast';
            alertDiv.setAttribute('role', 'alert');
            alertDiv.setAttribute('aria-live', 'assertive');
            
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                background: ${type === 'error' ? '#fee2e2' : type === 'success' ? '#d1fae5' : '#dbeafe'};
                color: ${type === 'error' ? '#991b1b' : type === 'success' ? '#065f46' : '#1e40af'};
                border-left: 4px solid ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            `;
            
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
        
        // Load features section after main content
        function loadFeaturesSection() {
            const featuresSection = document.getElementById('featuresSection');
            if (featuresSection) {
                featuresSection.classList.remove('hidden');
                featuresSection.innerHTML = `
                    <div class="container">
                        <h2 class="text-center" style="margin-bottom: 2rem;">Why Bulk Compression?</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                            <div style="text-align: center; padding: 2rem; background: var(--light); border-radius: var(--radius);">
                                <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <h3>Save Time</h3>
                                <p>Compress 20 images in the time it takes to do 1</p>
                            </div>
                            <div style="text-align: center; padding: 2rem; background: var(--light); border-radius: var(--radius);">
                                <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <h3>Consistent Quality</h3>
                                <p>Same compression settings across all images</p>
                            </div>
                            <div style="text-align: center; padding: 2rem; background: var(--light); border-radius: var(--radius);">
                                <div style="font-size: 2.5rem; color: var(--primary); margin-bottom: 1rem;">
                                    <i class="fas fa-file-archive"></i>
                                </div>
                                <h3>Batch Download</h3>
                                <p>Get all compressed images in one ZIP file</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Expose functions to global scope for onclick handlers
        window.removeImage = function(index) {
            if (selectedImages[index]) {
                URL.revokeObjectURL(selectedImages[index].previewUrl);
                selectedImages.splice(index, 1);
                updateImagesGrid();
                updateFileCounter();
                
                if (selectedImages.length === 0) {
                    imagesSection.classList.add('hidden');
                    controlsSection.classList.add('hidden');
                }
            }
        };
        
        window.clearAllImages = function() {
            selectedImages.forEach(img => URL.revokeObjectURL(img.previewUrl));
            selectedImages = [];
            compressedResults = [];
            
            imagesSection.classList.add('hidden');
            controlsSection.classList.add('hidden');
            resultsSection.classList.add('hidden');
            document.getElementById('resultsGridSection')?.classList.add('hidden');
            
            updateFileCounter();
            showAlert('All images cleared.', 'info');
        };
        
        window.showResultsGrid = function() {
            const resultsGrid = document.getElementById('resultsGrid');
            if (!resultsGrid) {
                const section = document.createElement('section');
                section.id = 'resultsGridSection';
                section.className = 'container';
                section.innerHTML = `
                    <h2 style="margin-bottom: 1rem;">Compression Results</h2>
                    <div class="image-grid" id="resultsGrid"></div>
                `;
                document.querySelector('main').appendChild(section);
            }
            
            const grid = document.getElementById('resultsGrid');
            const fragment = document.createDocumentFragment();
            
            compressedResults.forEach((image, index) => {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.innerHTML = `
                    <img src="${image.compressedBlob ? URL.createObjectURL(image.compressedBlob) : image.previewUrl}" 
                         class="image-preview" alt="Compressed: ${image.file.name}" loading="lazy">
                    <div style="margin-bottom: 0.5rem;">
                        <strong>${truncateText(image.file.name, 20)}</strong>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span style="color: #64748b;">Original:</span>
                            <span>${formatFileSize(image.originalSize)}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 0.875rem;">
                            <span style="color: #64748b;">Compressed:</span>
                            <span>${formatFileSize(image.compressedSize)}</span>
                        </div>
                    </div>
                    <div class="image-stats">
                        <span style="color: ${image.reduction > 0 ? '#10b981' : '#ef4444'}; font-weight: 600;">
                            ${image.reduction > 0 ? '▼' : '▲'} ${Math.abs(image.reduction).toFixed(1)}%
                        </span>
                        <span class="stat-badge">${image.format.toUpperCase()}</span>
                    </div>
                    <button onclick="downloadSingle(${index})" style="width: 100%; margin-top: 0.5rem; padding: 0.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer;">
                        <i class="fas fa-download"></i> Download
                    </button>
                `;
                fragment.appendChild(card);
            });
            
            grid.innerHTML = '';
            grid.appendChild(fragment);
            
            document.getElementById('resultsGridSection').classList.remove('hidden');
            resultsSection.classList.add('hidden');
        };
        
        window.downloadAllAsZip = function() {
            if (compressedResults.length === 0) return;
            
            compressedResults.forEach((image, index) => {
                setTimeout(() => downloadSingle(index), index * 100);
            });
            
            showAlert(`Starting download of ${compressedResults.length} images. In production, this would be a ZIP file.`, 'info');
        };
        
        window.downloadSingle = function(index) {
            const image = compressedResults[index];
            if (!image.compressedBlob) return;
            
            const filename = image.file.name.replace(/\.[^/.]+$/, "") + 
                           '-compressed.' + image.format;
            const url = URL.createObjectURL(image.compressedBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        };
    </script>
</body>
</html>
